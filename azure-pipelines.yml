# Python package
# Create and test a Python package on multiple Python versions.
# Add steps that analyze code, save the dist with the build record, publish to a PyPI-compatible index, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/python

trigger:
- master

pr:
  autoCancel: true
  branches:
    include:
      - master

schedules:
- cron: "0 0 * * *"
  displayName: Daily midnight build for master
  branches:
    include:
      - master

jobs:
- job: BleedingMoSDeF
  strategy:
    matrix:
      Python37Ubuntu:
        imageName: 'ubuntu-latest'
        python.version: 3.7
      #Python36Ubuntu:
      #  imageName: 'ubuntu-latest'
      #  python.version: 3.7
      #Python36macOS:
      #  imageName: 'macOS-latest'
      #  python.version: 3.6
      #Python37macOS:
      #  imageName: 'macOS-latest'
      #  python.version: 3.7

  pool:
    vmImage: $(imageName)

  steps:
    - bash: echo "##vso[task.prependpath]$CONDA/bin"
      displayName: Add Conda to path
    - bash : echo "##vso[task.prependpath]$(Build.SourcesDirectory)/mosdef_cassandra/tests/files/Cassandra_V1.2/bin"
      
    
    - bash: |
        conda config --set always_yes yes --set changeps1 no
        conda config --add channels omnia
        conda config --add channels janschulz
        conda config --add channels conda-forge
        conda config --add channels mosdef
        conda update -c defaults conda
        conda update --all
        conda create -n  bleeding-test-environment
      displayName: Create a new bleeding test environment

    - bash: |
        conda activate bleeding-test-environment
        conda install -c conda-forge fortran-compiler
        cd mosdef_cassandra/tests/files/
        tar -xzvf Cassandra_V1.2.tar.gz
        cd Cassandra_V1.2/Src
        make -f Makefile.gfortran
        mkdir ../bin
        cp cassandra_gfortran.exe ../bin/.
        cp ../Scripts/Frag_Library_Setup/library_setup.py ../bin/.
        cd ../../../../../
      displayName: Build Cassandra gfortran

    - bash: |
        echo Working directory:
        pwd
        echo ls:
        ls
        echo PATH:
        echo "$PATH"
        echo CASSANDRA:
        which cassandra_gfortran.exe
        echo PYTHON2
        which python2
        echo LIBRARY_SETUP:
        which library_setup.py
      displayName: Test cassandra setup

